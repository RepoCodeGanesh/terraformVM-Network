# Azure DevOps Pipeline for Terraform Infrastructure Deployment
# Production-Grade Configuration with Security & Best Practices

trigger:
  branches:
    include:
      - Vm-Network-ModuleforMultiVmDeploy
      - main
  paths:
    include:
      - '**/*.tf'
      - 'azure-pipelines.yml'

pr:
  branches:
    include:
      - Vm-Network-ModuleforMultiVmDeploy
      - main

variables:
  - group: Terraform-Secrets
  - name: terraformVersion
    value: '1.9.0'
  - name: azureCliVersion
    value: 'latest'
  - name: tfPlanArtifact
    value: 'terraform-plan'
  - name: System.PreferGitFromPath
    value: 'true'

pool:
  vmImage: 'ubuntu-latest'

stages:
  # ========================================
  # Stage 1: Validation & Security Scanning
  # ========================================
  - stage: Validate
    displayName: 'Terraform Validation & Security Scan'
    jobs:
      - job: ValidateAndScan
        displayName: 'Validate & Scan Terraform'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformTaskV2@2
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'azuredevops-azure'
              backendAzureRmResourceGroupName: '$(BACKEND_RESOURCE_GROUP)'
              backendAzureRmStorageAccountName: '$(BACKEND_STORAGE_ACCOUNT)'
              backendAzureRmContainerName: '$(BACKEND_CONTAINER)'
              backendAzureRmKey: '$(BACKEND_KEY)'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)

          - task: TerraformTaskV2@2
            displayName: 'Terraform Format Check'
            inputs:
              provider: 'azurerm'
              command: 'custom'
              customCommand: 'fmt'
              customArguments: '-check -recursive'
            continueOnError: true

          - task: TerraformTaskV2@2
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'

          - script: |
              terraform init \
                -backend-config="resource_group_name=$(BACKEND_RESOURCE_GROUP)" \
                -backend-config="storage_account_name=$(BACKEND_STORAGE_ACCOUNT)" \
                -backend-config="container_name=$(BACKEND_CONTAINER)" \
                -backend-config="key=$(BACKEND_KEY)"
              tfsec . --format json || true
            displayName: 'Terraform Security Scan (Tfsec)'
            continueOnError: true

  # ========================================
  # Stage 2: Plan & Cost Estimation
  # ========================================
  - stage: Plan
    displayName: 'Terraform Plan & Cost Estimate'
    dependsOn: Validate
    condition: succeeded()
    jobs:
      - job: PlanJob
        displayName: 'Generate Terraform Plan'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformTaskV2@2
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'azuredevops-azure'
              backendAzureRmResourceGroupName: '$(BACKEND_RESOURCE_GROUP)'
              backendAzureRmStorageAccountName: '$(BACKEND_STORAGE_ACCOUNT)'
              backendAzureRmContainerName: '$(BACKEND_CONTAINER)'
              backendAzureRmKey: '$(BACKEND_KEY)'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)

          - task: TerraformTaskV2@2
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              commandOptions: |
                -out=tfplan
                -lock=true
                -input=false
                -var="client_secret=$(CLIENT_SECRET)"
              environmentServiceNameAzureRM: 'azuredevops-azure'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)

          - script: |
              terraform show -json tfplan > tfplan.json
              echo "##[section]Plan Summary:"
              terraform show tfplan | tail -20
            displayName: 'Export Plan Summary'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Plan Artifact'
            inputs:
              pathToPublish: '$(System.DefaultWorkingDirectory)'
              artifactName: '$(tfPlanArtifact)'
              publishLocation: 'Container'

          - script: |
              echo "Plan generation completed successfully."
              echo "Review the plan before applying."
            displayName: 'Plan Completion Message'

  # ========================================
  # Stage 3: Plan Review & Approval
  # ========================================
  - stage: ReviewApproval
    displayName: 'Plan Review & Approval'
    dependsOn: Plan
    condition: succeeded()
    jobs:
      - job: HoldForReview
        displayName: 'Wait for Manual Approval'
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: 'Manual Approval Required'
            inputs:
              notifyUsers: 'Infrastructure-Team'
              instructions: |
                Review the Terraform plan carefully:
                1. Check resource changes
                2. Verify no unintended modifications
                3. Approve to proceed with apply
              onTimeout: 'reject'

  # ========================================
  # Stage 4: Apply Infrastructure Changes
  # ========================================
  - stage: Apply
    displayName: 'Terraform Apply'
    dependsOn: ReviewApproval
    condition: succeeded()
    jobs:
      - job: ApplyJob
        displayName: 'Apply Terraform Configuration'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: DownloadBuildArtifacts@0
            displayName: 'Download Plan Artifact'
            inputs:
              artifactName: '$(tfPlanArtifact)'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - script: |
              ls -la $(System.DefaultWorkingDirectory)/$(tfPlanArtifact)/
            displayName: 'List Downloaded Artifacts'
            continueOnError: true

          - task: TerraformTaskV2@2
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'azuredevops-azure'
              backendAzureRmResourceGroupName: '$(BACKEND_RESOURCE_GROUP)'
              backendAzureRmStorageAccountName: '$(BACKEND_STORAGE_ACCOUNT)'
              backendAzureRmContainerName: '$(BACKEND_CONTAINER)'
              backendAzureRmKey: '$(BACKEND_KEY)'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)

          - task: TerraformTaskV2@2
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              commandOptions: |
                -lock=true
                -input=false
                -auto-approve
                -var="client_secret=$(CLIENT_SECRET)"
                $(System.DefaultWorkingDirectory)/$(tfPlanArtifact)/tfplan
              environmentServiceNameAzureRM: 'azuredevops-azure'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)

          - script: |
              echo "Terraform apply completed successfully!"
              terraform output -json > outputs.json
            displayName: 'Export Outputs'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Apply Outputs'
            inputs:
              pathToPublish: '$(System.DefaultWorkingDirectory)'
              artifactName: 'terraform-outputs'
              publishLocation: 'Container'

  # ========================================
  # Stage 5: Post-Deployment Validation
  # ========================================
  - stage: PostDeploymentValidation
    displayName: 'Post-Deployment Validation'
    dependsOn: Apply
    condition: succeeded()
    jobs:
      - job: ValidationJob
        displayName: 'Validate Deployed Resources'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: AzureCLI@2
            displayName: 'Validate Azure Resources'
            inputs:
              azureSubscription: 'azuredevops-azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Validating deployed Azure resources..."
                az group list --output table
                echo "Resource groups validation complete."
            continueOnError: true

  # ========================================
  # Stage 6: Cleanup (Optional - Dev/Test Only)
  # ========================================
  - stage: Cleanup
    displayName: 'Cleanup (Manual Trigger Only)'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/cleanup')
    dependsOn: PostDeploymentValidation
    jobs:
      - job: ConfirmDestroy
        displayName: 'Confirm Destroy'
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: 'Confirm Resource Destruction'
            inputs:
              notifyUsers: 'Infrastructure-Team'
              instructions: 'WARNING: This will destroy all managed resources. Confirm to proceed.'
              onTimeout: 'reject'

      - job: DestroyResources
        displayName: 'Destroy Infrastructure'
        dependsOn: ConfirmDestroy
        condition: succeeded()
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformTaskV2@2
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'azuredevops-azure'
              backendAzureRmResourceGroupName: '$(BACKEND_RESOURCE_GROUP)'
              backendAzureRmStorageAccountName: '$(BACKEND_STORAGE_ACCOUNT)'
              backendAzureRmContainerName: '$(BACKEND_CONTAINER)'
              backendAzureRmKey: '$(BACKEND_KEY)'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)

          - task: TerraformTaskV2@2
            displayName: 'Terraform Destroy'
            inputs:
              provider: 'azurerm'
              command: 'destroy'
              commandOptions: '-auto-approve -lock=true -input=false -var="client_secret=$(CLIENT_SECRET)"'
              environmentServiceNameAzureRM: 'azuredevops-azure'
            env:
              ARM_CLIENT_ID: $(CLIENT_ID)
              ARM_CLIENT_SECRET: $(CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(TENANT_ID)