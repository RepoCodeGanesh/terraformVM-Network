trigger:
  branches:
    include:
      - main
  paths:
    include:
      - '**/*.tf'
      - 'azure-pipelines.prod.yml'

pr:
  branches:
    include:
      - main

parameters:
- name: environment
  displayName: 'Target Environment'
  type: string
  default: 'dev'
  values:
    - dev
    - staging
    - prod

- name: runValidation
  displayName: 'Run Validation & Security Checks'
  type: boolean
  default: true

- name: runCostEstimate
  displayName: 'Estimate Infrastructure Costs'
  type: boolean
  default: true

variables:
- group: Terraform-Secrets
- name: TERRAFORM_VERSION
  value: '1.5.7'
- name: TF_INPUT
  value: 'false'
- name: TF_IN_AUTOMATION
  value: 'true'
- ${{ if eq(parameters.environment, 'dev') }}:
  - name: ENVIRONMENT
    value: 'dev'
  - name: TF_WORKSPACE
    value: 'dev'
  - name: TFVARS_FILE
    value: 'terraform.dev.tfvars'
- ${{ if eq(parameters.environment, 'staging') }}:
  - name: ENVIRONMENT
    value: 'staging'
  - name: TF_WORKSPACE
    value: 'staging'
  - name: TFVARS_FILE
    value: 'terraform.staging.tfvars'
- ${{ if eq(parameters.environment, 'prod') }}:
  - name: ENVIRONMENT
    value: 'prod'
  - name: TF_WORKSPACE
    value: 'prod'
  - name: TFVARS_FILE
    value: 'terraform.prod.tfvars'

stages:
- stage: Validation
  displayName: 'Terraform Validation & Security'
  condition: eq('${{ parameters.runValidation }}', 'true')
  jobs:
  - job: ValidateAndScan
    displayName: Validate, Format Check & Security Scan
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    
    - task: AzureCLI@2
      displayName: Setup Terraform & Validate
      inputs:
        azureSubscription: 'azuredevops-azure'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e
          echo "==== Installing Terraform $(TERRAFORM_VERSION) ===="
          wget -q https://releases.hashicorp.com/terraform/$(TERRAFORM_VERSION)/terraform_$(TERRAFORM_VERSION)_linux_amd64.zip -O /tmp/terraform.zip
          unzip -o /tmp/terraform.zip -d /tmp
          sudo mv /tmp/terraform /usr/local/bin/terraform
          terraform version
          
          echo ""
          echo "==== Terraform Format Check ===="
          terraform fmt -check -recursive . || (echo "Files not formatted. Run: terraform fmt -recursive ." && exit 1)
          
          echo ""
          echo "==== Terraform Init (Validation) ===="
          terraform init -input=false -backend=false
          
          echo ""
          echo "==== Terraform Validate ===="
          terraform validate
    
    - task: Bash@3
      displayName: Security Scan - TFSec
      inputs:
        targetType: 'inline'
        script: |
          echo "==== Installing TFSec ===="
          curl -sL https://github.com/aquasecurity/tfsec/releases/download/v1.28.0/tfsec-linux-amd64 -o /tmp/tfsec
          chmod +x /tmp/tfsec
          echo ""
          echo "==== Running TFSec Scan ===="
          /tmp/tfsec . --minimum-severity MEDIUM --format json > tfsec-report.json || true
          cat tfsec-report.json | jq '.' || echo "No high-severity issues found."
    
    - task: PublishPipelineArtifact@1
      displayName: Publish Security Reports
      condition: always()
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/tfsec-report.json'
        artifact: 'security-report'

- stage: Plan
  displayName: 'Terraform Plan - $(ENVIRONMENT)'
  dependsOn: []
  condition: succeeded()
  jobs:
  - job: TerraformPlan
    displayName: Plan Infrastructure Changes
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    
    - task: AzureCLI@2
      displayName: Terraform Init & Plan
      inputs:
        azureSubscription: 'azuredevops-azure'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e
          echo "==== Installing Terraform $(TERRAFORM_VERSION) ===="
          wget -q https://releases.hashicorp.com/terraform/$(TERRAFORM_VERSION)/terraform_$(TERRAFORM_VERSION)_linux_amd64.zip -O /tmp/terraform.zip
          unzip -o /tmp/terraform.zip -d /tmp
          sudo mv /tmp/terraform /usr/local/bin/terraform
          
          echo ""
          echo "==== Setting Azure Credentials ===="
          export ARM_CLIENT_ID=$(CLIENT_ID)
          export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
          export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
          export ARM_TENANT_ID=$(TENANT_ID)
          
          echo ""
          echo "==== Exporting Terraform Variables ===="
          export TF_VAR_client_secret=$(CLIENT_SECRET)
          export TF_VAR_client_id=$(CLIENT_ID)
          export TF_VAR_subscription_id=$(SUBSCRIPTION_ID)
          export TF_VAR_tenant_id=$(TENANT_ID)
          
          echo ""
          echo "==== Initializing Terraform Backend ===="
          terraform init \
            -input=false \
            -backend-config="storage_account_name=$(BACKEND_STORAGE_ACCOUNT)" \
            -backend-config="container_name=$(BACKEND_CONTAINER)" \
            -backend-config="key=$(ENVIRONMENT).terraform.tfstate" \
            -backend-config="resource_group_name=$(BACKEND_RESOURCE_GROUP)" \
            -backend-config="access_key=$(BACKEND_STORAGE_KEY)"
          
          echo ""
          echo "==== Selecting Workspace: $(TF_WORKSPACE) ===="
          terraform workspace select $(TF_WORKSPACE) || terraform workspace new $(TF_WORKSPACE)
          
          echo ""
          echo "==== Running Terraform Plan ===="
          terraform plan \
            -input=false \
            -var-file="$(TFVARS_FILE)" \
            -out=tfplan_$(ENVIRONMENT)
    
    - task: Bash@3
      displayName: Generate Plan Summary & JSON
      inputs:
        targetType: 'inline'
        script: |
          set -e
          export ARM_CLIENT_ID=$(CLIENT_ID)
          export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
          export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
          export ARM_TENANT_ID=$(TENANT_ID)
          
          echo "==== Converting Plan to JSON ===="
          terraform show -json tfplan_$(ENVIRONMENT) > tfplan_$(ENVIRONMENT).json
          
          echo ""
          echo "==== Generating Categorized Summary ===="
          echo "=== TERRAFORM PLAN SUMMARY - $(ENVIRONMENT) ===" > tfplan-summary_$(ENVIRONMENT).txt
          echo "Timestamp: $(date)" >> tfplan-summary_$(ENVIRONMENT).txt
          echo "" >> tfplan-summary_$(ENVIRONMENT).txt
          
          jq -r '
            [.resource_changes[] | {resource: "\(.type).\(.name)\(if .index then "[\(.index)]" else "" end)", actions: .change.actions}] |
            group_by(.actions | join("-")) |
            map({action: .[0].actions | join("-"), resources: map(.resource)}) |
            sort_by(.action) |
            .[] |
            "\(.action | ascii_upcase) (\(.resources | length) resource\(if (.resources | length) > 1 then "s" else "" end)):\n" + (.resources | map("  \(.)") | join("\n"))
          ' tfplan_$(ENVIRONMENT).json >> tfplan-summary_$(ENVIRONMENT).txt 2>/dev/null || echo "Plan summary generated."
          
          echo ""
          cat tfplan-summary_$(ENVIRONMENT).txt

    - task: Bash@3
      displayName: Estimate Infrastructure Costs (Infracost)
      condition: eq('${{ parameters.runCostEstimate }}', 'true')
      continueOnError: true
      inputs:
        targetType: 'inline'
        script: |
          echo "==== Installing Infracost ===="
          curl -sL https://github.com/infracost/infracost/releases/latest/download/infracost-linux-x64.tar.gz | tar xz -C /tmp
          /tmp/infracost --version
          
          echo ""
          echo "==== Estimating Infrastructure Costs ===="
          /tmp/infracost breakdown --path tfplan_$(ENVIRONMENT).json --format table > cost-estimate_$(ENVIRONMENT).txt 2>&1 || echo "Cost estimation skipped."
          cat cost-estimate_$(ENVIRONMENT).txt

    - task: PublishPipelineArtifact@1
      displayName: Publish Plan Artifacts
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)'
        artifact: 'terraform-plan-$(ENVIRONMENT)'
        publishLocation: 'pipeline'

- stage: Review
  displayName: 'Manual Review - $(ENVIRONMENT)'
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - job: waitForValidation
    displayName: Awaiting Approval to Apply
    pool: server
    timeoutInMinutes: 1440
    steps:
    - task: ManualValidation@0
      displayName: Approve/Reject Apply
      inputs:
        notifyUsers: 'richt@example.com'
        instructions: |
          Review the Terraform plan artifacts and cost estimate.
          Approve to proceed with Apply, or Reject to cancel.
        onTimeout: 'reject'

- stage: Apply
  displayName: 'Terraform Apply - $(ENVIRONMENT)'
  dependsOn: Review
  condition: succeeded()
  jobs:
  - deployment: TerraformApply
    displayName: Apply Infrastructure Changes
    environment: 'terraform-$(ENVIRONMENT)'
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          
          - task: DownloadPipelineArtifact@2
            displayName: Download Plan Artifacts
            inputs:
              artifact: 'terraform-plan-$(ENVIRONMENT)'
              path: '$(System.DefaultWorkingDirectory)'
          
          - task: AzureCLI@2
            displayName: Terraform Apply
            inputs:
              azureSubscription: 'azuredevops-azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e
                echo "==== Installing Terraform $(TERRAFORM_VERSION) ===="
                wget -q https://releases.hashicorp.com/terraform/$(TERRAFORM_VERSION)/terraform_$(TERRAFORM_VERSION)_linux_amd64.zip -O /tmp/terraform.zip
                unzip -o /tmp/terraform.zip -d /tmp
                sudo mv /tmp/terraform /usr/local/bin/terraform
                
                echo ""
                echo "==== Setting Azure Credentials ===="
                export ARM_CLIENT_ID=$(CLIENT_ID)
                export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
                export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
                export ARM_TENANT_ID=$(TENANT_ID)
                
                echo ""
                echo "==== Exporting Terraform Variables ===="
                export TF_VAR_client_secret=$(CLIENT_SECRET)
                export TF_VAR_client_id=$(CLIENT_ID)
                export TF_VAR_subscription_id=$(SUBSCRIPTION_ID)
                export TF_VAR_tenant_id=$(TENANT_ID)
                
                echo ""
                echo "==== Initializing Terraform Backend ===="
                terraform init \
                  -input=false \
                  -backend-config="storage_account_name=$(BACKEND_STORAGE_ACCOUNT)" \
                  -backend-config="container_name=$(BACKEND_CONTAINER)" \
                  -backend-config="key=$(ENVIRONMENT).terraform.tfstate" \
                  -backend-config="resource_group_name=$(BACKEND_RESOURCE_GROUP)" \
                  -backend-config="access_key=$(BACKEND_STORAGE_KEY)"
                
                echo ""
                echo "==== Selecting Workspace: $(TF_WORKSPACE) ===="
                terraform workspace select $(TF_WORKSPACE)
                
                echo ""
                echo "==== Applying Terraform Plan ===="
                terraform apply -input=false tfplan_$(ENVIRONMENT)
                
                echo ""
                echo "==== Capturing Terraform Outputs ===="
                terraform output -json > outputs_$(ENVIRONMENT).json

          - task: PublishPipelineArtifact@1
            displayName: Publish Outputs
            condition: always()
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/outputs_$(ENVIRONMENT).json'
              artifact: 'terraform-outputs-$(ENVIRONMENT)'

- stage: Destroy
  displayName: 'Terraform Destroy - $(ENVIRONMENT)'
  dependsOn: Plan
  condition: and(succeeded(), eq('${{ variables['Build.SourceBranch'] }}', 'refs/heads/main'))
  jobs:
  - deployment: TerraformDestroy
    displayName: Destroy Infrastructure
    environment: 'terraform-$(ENVIRONMENT)-destroy'
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          
          - task: AzureCLI@2
            displayName: Terraform Destroy
            inputs:
              azureSubscription: 'azuredevops-azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e
                echo "==== ⚠️  WARNING: DESTROYING INFRASTRUCTURE IN $(ENVIRONMENT) ⚠️ ===="
                echo "This action cannot be undone!"
                sleep 5
                
                echo ""
                echo "==== Installing Terraform $(TERRAFORM_VERSION) ===="
                wget -q https://releases.hashicorp.com/terraform/$(TERRAFORM_VERSION)/terraform_$(TERRAFORM_VERSION)_linux_amd64.zip -O /tmp/terraform.zip
                unzip -o /tmp/terraform.zip -d /tmp
                sudo mv /tmp/terraform /usr/local/bin/terraform
                
                echo ""
                echo "==== Setting Azure Credentials ===="
                export ARM_CLIENT_ID=$(CLIENT_ID)
                export ARM_CLIENT_SECRET=$(CLIENT_SECRET)
                export ARM_SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)
                export ARM_TENANT_ID=$(TENANT_ID)
                
                echo ""
                echo "==== Exporting Terraform Variables ===="
                export TF_VAR_client_secret=$(CLIENT_SECRET)
                export TF_VAR_client_id=$(CLIENT_ID)
                export TF_VAR_subscription_id=$(SUBSCRIPTION_ID)
                export TF_VAR_tenant_id=$(TENANT_ID)
                
                echo ""
                echo "==== Initializing Terraform Backend ===="
                terraform init \
                  -input=false \
                  -backend-config="storage_account_name=$(BACKEND_STORAGE_ACCOUNT)" \
                  -backend-config="container_name=$(BACKEND_CONTAINER)" \
                  -backend-config="key=$(ENVIRONMENT).terraform.tfstate" \
                  -backend-config="resource_group_name=$(BACKEND_RESOURCE_GROUP)" \
                  -backend-config="access_key=$(BACKEND_STORAGE_KEY)"
                
                echo ""
                echo "==== Selecting Workspace: $(TF_WORKSPACE) ===="
                terraform workspace select $(TF_WORKSPACE)
                
                echo ""
                echo "==== Destroying Infrastructure ===="
                terraform destroy -input=false -auto-approve -var-file="$(TFVARS_FILE)"
